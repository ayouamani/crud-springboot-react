- name: Deploy CRUD to EKS (NodePort, no ingress)
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    namespace: "{{ namespace | default('crud') }}"
    backend_image: "{{ backend_image }}"
    frontend_image: "{{ frontend_image }}"

  tasks:
    - name: Create namespace
      kubernetes.core.k8s:
        state: present
        src: "k8s/namespace.yml"

    - name: Deploy MySQL
      kubernetes.core.k8s:
        state: present
        namespace: "{{ namespace }}"
        src: "k8s/mysql.yml"

    - name: Render backend manifest
      set_fact:
        backend_yaml: "{{ lookup('file', 'k8s/backend.yml') | replace('__BACKEND_IMAGE__', backend_image) }}"

    - name: Apply backend
      kubernetes.core.k8s:
        state: present
        namespace: "{{ namespace }}"
        definition: "{{ backend_yaml | from_yaml_all | list }}"

    - name: Render frontend manifest
      set_fact:
        frontend_yaml: "{{ lookup('file', 'k8s/frontend.yml') | replace('__FRONTEND_IMAGE__', frontend_image) }}"

    - name: Apply frontend
      kubernetes.core.k8s:
        state: present
        namespace: "{{ namespace }}"
        definition: "{{ frontend_yaml | from_yaml_all | list }}"
